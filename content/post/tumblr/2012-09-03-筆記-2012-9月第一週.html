---
date: "2012-09-03T01:05:41Z"
tags:
- IFTTT
- Blogger
title: '[筆記] 2012 9月第一週'
tumblr_url: http://blog.jln.co/post/30734043722/筆記-2012-9月第一週
---
這禮拜想到的東西真有點雜, 標題只好隨便下, 本來這週給自己要求的進度應該要再多一點, 結果最後只為了node for Android加了Android log的機制<br/><br/><h3><b>node for Android</b></h3>這週本來預定的目標是串接上NativeActivity, 不過, 沒做到, 需要多花點時間想切入點:<br/><ol><li>pass &ldquo;struct android_app *&rdquo; to Node (從android_main呼叫新的node::Start)</li><li>wrap &ldquo;struct android_app *&rdquo; (是否要依附在process object? 參考資料: node_object_wrap.h, v8::Object::SetPointerInInternalField)</li><li>Design of callbacks for AppCmd, InputEvent (NativeActivity &ndash;&gt; Node)</li></ol>這邊有點頭痛, 要找到一個比較好的切入點設計一個新的架構給NativeActivity, 不過這邊又回頭想了一個問題, 到底Node適不適合UI programming, 還是當做一個server, 掛到一個Android service會比較適合?<br/><br/>adding native module to Node:<br/>為了練習這部份, 把android log的機制加進去, 完成後可以在js裡用下面這樣叫用Android log<br/><blockquote class="tr_bq"><i>require(&lsquo;android&rsquo;);</i><br/><i>alog.d('tag&rsquo;, 'message1&rsquo;); //debug log</i><br/><i>alog.e('tag&rsquo;, 'var a=&rsquo;, a, &rsquo; found&rsquo;, 1, 'error&rsquo;); //error log</i></blockquote>由這code看, 主要有兩個部分, 一個是一個名為android的module, 一個是alog這個global object (Node本身已有&quot;log&quot;, 為避免衝突, 改名為alog)<br/><br/>新增module的參考資料為: <a href="http://bit.ly/RzIQWl">http://bit.ly/RzIQWl </a>, 不過, 這邊加的不是addon而是一個native module, 所以有點不同, 首先為了這個module新增了, node_android.cc (class Android), 名字一定要是&quot;node_&ldquo;開頭 , 這是由於binding時, 會尋找&quot;node_&quot;開頭的module (參考 node_extensions.cc : get_builtin_module), 這邊主要implement的是用&quot;NODE_SET_METHOD&quot;加入新的method &quot;log&rdquo;, 用&quot;NODE_DEFINE_CONSTANT&quot;映射了幾個log level的常數, 最後用&quot;NODE_MODULE&quot;定義module的init method<br/><blockquote class="tr_bq">Source code: <a href="http://bit.ly/RzIOxD">http://bit.ly/RzIOxD</a></blockquote>不過這樣不夠, 因為我要的不是只有&quot;log&quot;, 而是要像&quot;alog.d&quot;這樣的東西, 因此又多了一個android.js來處理:<br/><div class="highlight"><pre><div class="line" id="LC1"><br/><span class="kd"> </span></div><br/><div class="line" id="LC1"><br/><i><span class="kd">var</span> <span class="nx">binding</span> <span class="o">=</span> <b style="color: red;"><span class="nx">process</span><span class="p">.</span><span class="nx">binding</span><span class="p">(</span><span class="s1">'android'</span><span class="p">);</span></b></i></div><br/><div class="line" id="LC2"><br/><i><br/></i></div><br/><div class="line" id="LC3"><br/><i><span class="kd">function</span> <span class="nx">log</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">args</span><span class="p">)</span> <span class="p">{</span></i></div><br/><div class="line" id="LC4"><br/><i>    <span class="kd">var</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></i></div><br/><div class="line" id="LC5"><br/><i>    <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></i></div><br/><div class="line" id="LC6"><br/><i>    <span class="kd">var</span> <span class="nx">objs</span> <span class="o">=</span> <span class="p">[];</span></i></div><br/><div class="line" id="LC7"><br/><i><br/></i></div><br/><div class="line" id="LC8"><br/><i>    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></i></div><br/><div class="line" id="LC9"><br/><i>       <span class="nx">objs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span></i></div><br/><div class="line" id="LC10"><br/><i>    <span class="p">}</span></i></div><br/><div class="line" id="LC11"><br/><i>    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="nx">objs</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">);</span></i></div><br/><div class="line" id="LC12"><br/><i><br/></i></div><br/><div class="line" id="LC13"><br/><i>    <span class="nx">binding</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">level</span><span class="p">,</span> <span class="nx">tag</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span></i></div><br/><div class="line" id="LC14"><br/><i><span class="p">}</span></i></div><br/><div class="line" id="LC15"><br/><i><br/></i></div><br/><div class="line" id="LC16"><br/><i><span class="kd">var</span> <span class="nx">alog</span> <span class="o">=</span> <span class="p">{</span></i></div><br/><div class="line" id="LC17"><br/><i>    <span class="nx">v</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></i></div><br/><div class="line" id="LC18"><br/><i>        <span class="nx">log</span><span class="p">(</span><b><span class="nx" style="color: red;">binding</span><span class="p" style="color: red;">.</span><span class="nx" style="color: red;">ANDROID_LOG_VERBOSE</span></b><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span></i></div><br/><div class="line" id="LC19"><br/><i>    <span class="p">},</span></i></div><br/><div class="line" id="LC20"><br/><i>    <span class="nx">d</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></i></div><br/><div class="line" id="LC21"><br/><i>        <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">.</span><span class="nx">ANDROID_LOG_DEBUG</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span></i></div><br/><div class="line" id="LC22"><br/><i>    <span class="p">},</span></i></div><br/><div class="line" id="LC23"><br/><i>    <span class="nx">i</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></i></div><br/><div class="line" id="LC24"><br/><i>        <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">.</span><span class="nx">ANDROID_LOG_INFO</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span></i></div><br/><div class="line" id="LC25"><br/><i>    <span class="p">},</span></i></div><br/><div class="line" id="LC26"><br/><i>    <span class="nx">w</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></i></div><br/><div class="line" id="LC27"><br/><i>        <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">.</span><span class="nx">ANDROID_LOG_WARN</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span></i></div><br/><div class="line" id="LC28"><br/><i>    <span class="p">},</span></i></div><br/><div class="line" id="LC29"><br/><i>    <span class="nx">e</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></i></div><br/><div class="line" id="LC30"><br/><i>        <span class="nx">log</span><span class="p">(</span><span class="nx">binding</span><span class="p">.</span><span class="nx">ANDROID_LOG_ERROR</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span></i></div><br/><div class="line" id="LC31"><br/><i>    <span class="p">}</span></i></div><br/><div class="line" id="LC32"><br/><i><span class="p">};</span></i></div><br/><div class="line" id="LC33"><br/><i><br/></i></div><br/><div class="line" id="LC34" style="color: red;"><br/><b><i><span class="nx">global</span><span class="p">.</span><span class="nx">alog</span> <span class="o">=</span> <span class="nx">alog</span><span class="p">;</span></i></b></div><br/></pre></div><br/><br style="clear: both;"/><br/>首先用了process.binding來bind剛剛native的部份, 另為就是把alog變成global object<br/><br style="clear: both;"/><br/><h3>其他TODO</h3>Idea board, Bluetooth OPP&hellip;.還沒想fb world hack做啥好<br style="clear: both;"/><br/><br/>
via Blogger <a href="http://bit.ly/RzIOxF">http://bit.ly/RzIOxF</a>
