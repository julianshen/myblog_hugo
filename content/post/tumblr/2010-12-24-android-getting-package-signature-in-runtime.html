---
date: "2010-12-24T23:42:22Z"
tags:
- Android
- Mobile Dev
title: '[Android] Getting package signature in runtime'
tumblr_url: http://blog.jln.co/post/2446282701/android-getting-package-signature-in-runtime
---
<div class="posterous_autopost"><p>如果使用過Google MapView你會發現G社會叫你用你的package signature去申請map key(<a href="http://code.google.com/intl/zh-TW/android/add-ons/google-apis/mapkey.html">參考這邊</a>)</p>  <p>那MapView本身又是如何取得你的package signature的呢? </p>  <p>其實很簡單, 可以透過目前的Context用<a href="http://developer.android.com/reference/android/content/Context.html#getPackageName()">Context.getPackageName()</a>取得package name, 然後再利用package name去<a href="http://developer.android.com/reference/android/content/pm/PackageManager.html#getPackageInfo(java.lang.String,%20int)">PackageManager.getPackageInfo()</a>去查詢package的資訊(<a href="http://developer.android.com/reference/android/content/pm/PackageInfo.html">PackageInfo</a>), 裡面有項資訊&quot;signatures&quot;就是我們所要的(一個package是可以被sign多次的)</p>  <p><a href="https://github.com/facebook/facebook-android-sdk">Facebook Android SDK</a>所提供的Single sign on (SSO)也是得先在server端註冊你的package signature, 這樣它可以避免別人偷用你的API key去做single sign on的動作(因為別人的AP可能不會跟你sign同一個signature)</p>  <p>但Facebook的SSO是透過Facebook for Android來做login的動作的, 你的application是透過startActivityForResult去叫Facebook for Android, 這牽涉到兩個不同的package, 如果依上面的例子的話, MapView其實是鑲嵌在你的UI上, 跟你的application是同一個package, 所以可以拿context來取得這資訊</p>  <p>Facebook for Android是如何取得call他的人的signature呢?</p>  <p>其實也是用<a href="http://developer.android.com/reference/android/content/pm/PackageManager.html#getPackageInfo(java.lang.String,%20int)">PackageManager.getPackageInfo()</a> 來取得, 但它如何知道呼叫他的人是哪個package的?</p>  <p>這只要組合兩個API就可以辦到了</p>  <p>第一個是<a href="http://developer.android.com/reference/android/os/Binder.html#getCallingUid()">Binder.getCallingUid()</a> , 這可以讓你取得你的Calling process的UID</p>  <p>第二個是<a href="http://developer.android.com/reference/android/content/pm/PackageManager.html#getPackagesForUid(int)">PackageManager.getPackagesForUid()</a> , 這可以讓你取得屬於這UID的所有package</p>  <p>或許這邊你可能會有點疑問, 不是不同的package可以share UID嗎? 這樣取出來的package可能有很多個, 我怎知道用哪個? 我們目的只是要取得signature, 所以用哪個都一樣, 因為share UID的必要條件就是這些相同UID的package都是要sign同一把key, 所以只要找出所有package共通的signature就大功告成了 </p>  </div>
