---
date: "2010-12-07T22:52:27Z"
tags:
- Android
- Mobile Dev
title: '[Android] Access remote data on another process using ContentProvider and
  Cursor'
tumblr_url: http://blog.jln.co/post/2132822453/android-access-remote-data-on-another-process
---
<div class="posterous_autopost"><p>這篇要示範的是, 如何寫一個ContentProvider讓其他的應用程式透過這個Provider去存取網路上的資料</p>  <p>這不是正統用法, 不過的確可以這樣用, 那為啥要這樣呢? 只是好玩, 還沒想到特別的應用</p>  <p>這邊用的範例是Twitter search (search keyword): MLB</p>  <p>首先要建立一個放Provider的Package, 不過這個Provider不是拿來存取DB的, 傳統的Android ContentProvider通常是用來存取資料庫, 但那並不代表那就是它的全部, &ldquo;Content&quot;Provider不就是拿來提供&quot;Content&quot;的嘛?管他Content哪來</p>  <p>建立一個Provider, 姑且叫它做TwitterSearchProvider, Authorities定為twitter.my.search好了, 裡面, 先只實作一個&quot;query&quot; </p>  <blockquote>  <p>p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco} span.s1 {color: #9a1867} span.Apple-tab-span {white-space:pre}  </p><p class="p1"><span> </span><span class="s1">public</span> Cursor query(Uri uri, String[] projection, String selection,</p>  <p class="p1"><span> </span><span> </span><span> </span>String[] selectionArgs, String sortOrder) {</p>  <p class="p1"><span> </span><span> </span><span class="s1">return</span> <span class="s1">new</span> TwitterSearchCursor();</p>  <p class="p1"><span> </span>}</p>    </blockquote>  <p>這Query啥事都不用作, 回傳個TwitterSearchCursor就好了</p>  <p>從這看出玄機了嘛? 我們就是要利用Cursor, 在Cursor裡面實作連接網路取得資料的動作</p>  <p>後面我懶得寫解釋了, MBP快沒電了, 以下就是TwitterSearchCursor的Source:</p>    <blockquote>  <p>p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco} p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; min-height: 15.0px} p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color: #9a1867} p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color: #777777} p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color: #429073} p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color: #382ffa} p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 11.0px Monaco; color: #0023c7} span.s1 {color: #9a1867} span.s2 {color: #000000} span.s3 {color: #0023c7} span.s4 {color: #382ffa} span.s5 {color: #8dafc9} span.Apple-tab-span {white-space:pre}  </p><p class="p1"><span class="s1">public</span> <span class="s1">class</span> TwitterSearchCursor <span class="s1">extends</span> AbstractCursor {</p>    <p class="p3"><span class="s2"><span> </span></span>static<span class="s2"> </span>class<span class="s2"> Tweet {</span></p>  <p class="p1"><span> </span><span> </span>String <span class="s3">created_at</span> = <span class="s4">&rdquo;&ldquo;</span>;</p>  <p class="p1"><span> </span><span> </span>String <span class="s3">id_str</span> = <span class="s4">&rdquo;&ldquo;</span>;</p>  <p class="p1"><span> </span><span> </span>String <span class="s3">text</span> = <span class="s4">&rdquo;&ldquo;</span>;</p>  <p class="p1"><span> </span>}</p>  <p class="p2"><span> </span></p>  <p class="p1"><span> </span>ArrayList&lt;Tweet&gt; <span class="s3">tweets</span> = <span class="s1">new</span> ArrayList&lt;Tweet&gt;();</p>  <p class="p2"><span> </span></p>  <p class="p4"><span class="s2"><span> </span></span>@Override</p>  <p class="p1"><span> </span><span class="s1">public</span> String[] getColumnNames() {</p>  <p class="p5"><span class="s2"><span> </span><span> </span></span>// <span class="s5">TODO</span> Auto-generated method stub</p>  <p class="p6"><span class="s2"><span> </span><span> </span></span><span class="s1">return</span><span class="s2"> </span><span class="s1">new</span><span class="s2"> String[] {</span>&rdquo;_id&quot;<span class="s2">, </span>&ldquo;created_at&rdquo;<span class="s2">,</span>&ldquo;id_str&rdquo;<span class="s2">,</span>&ldquo;text&rdquo;<span class="s2">};</span></p>  <p class="p1"><span> </span>}</p>    <p class="p4"><span class="s2"><span> </span></span>@Override</p>  <p class="p1"><span> </span><span class="s1">public</span> <span class="s1">int</span> getCount() {</p>  <p class="p1"><span> </span><span> </span><span class="s1">if</span>(<span class="s3">tweets</span>.size() == 0) {</p>  <p class="p1"><span> </span><span> </span><span> </span>loadData();</p>  <p class="p1"><span> </span><span> </span>}</p>  <p class="p2"><span> </span><span> </span></p>  <p class="p1"><span> </span><span> </span>Log.d(<span class="s4">&ldquo;AAAA&rdquo;</span>, <span class="s4">&ldquo;cnt=&rdquo;</span>+<span class="s3">tweets</span>.size());</p>  <p class="p1"><span> </span><span> </span><span class="s1">return</span> <span class="s3">tweets</span>.size();</p>  <p class="p1"><span> </span>}</p>    <p class="p4"><span class="s2"><span> </span></span>@Override</p>  <p class="p1"><span> </span><span class="s1">public</span> <span class="s1">double</span> getDouble(<span class="s1">int</span> arg0) {</p>  <p class="p5"><span class="s2"><span> </span><span> </span></span>// <span class="s5">TODO</span> Auto-generated method stub</p>  <p class="p3"><span class="s2"><span> </span><span> </span></span>return<span class="s2"> 0;</span></p>  <p class="p1"><span> </span>}</p>    <p class="p4"><span class="s2"><span> </span></span>@Override</p>  <p class="p1"><span> </span><span class="s1">public</span> <span class="s1">float</span> getFloat(<span class="s1">int</span> arg0) {</p>  <p class="p5"><span class="s2"><span> </span><span> </span></span>// <span class="s5">TODO</span> Auto-generated method stub</p>  <p class="p3"><span class="s2"><span> </span><span> </span></span>return<span class="s2"> 0;</span></p>  <p class="p1"><span> </span>}</p>    <p class="p4"><span class="s2"><span> </span></span>@Override</p>  <p class="p1"><span> </span><span class="s1">public</span> <span class="s1">int</span> getInt(<span class="s1">int</span> index) {</p>  <p class="p1"><span> </span><span> </span><span class="s1">return</span> index;</p>  <p class="p1"><span> </span>}</p>    <p class="p4"><span class="s2"><span> </span></span>@Override</p>  <p class="p1"><span> </span><span class="s1">public</span> <span class="s1">long</span> getLong(<span class="s1">int</span> index) {</p>  <p class="p1"><span> </span><span> </span><span class="s1">return</span> index;</p>  <p class="p1"><span> </span>}</p>    <p class="p4"><span class="s2"><span> </span></span>@Override</p>  <p class="p1"><span> </span><span class="s1">public</span> <span class="s1">short</span> getShort(<span class="s1">int</span> index) {</p>  <p class="p1"><span> </span><span> </span><span class="s1">return</span> (<span class="s1">short</span>)index;</p>  <p class="p1"><span> </span>}</p>    <p class="p4"><span class="s2"><span> </span></span>@Override</p>  <p class="p1"><span> </span><span class="s1">public</span> String getString(<span class="s1">int</span> index) {</p>  <p class="p1"><span> </span><span> </span>Tweet t = <span class="s3">tweets</span>.get(<span class="s3">mPos</span>);</p>  <p class="p2"><span> </span><span> </span></p>  <p class="p1"><span> </span><span> </span><span class="s1">switch</span>(index) {</p>  <p class="p1"><span> </span><span> </span><span class="s1">case</span> 1:</p>  <p class="p7"><span class="s2"><span> </span><span> </span><span> </span></span><span class="s1">return</span><span class="s2"> </span><span class="s4">&ldquo;&rdquo;</span><span class="s2">+t.</span>created_at<span class="s2">;</span></p>  <p class="p1"><span> </span><span> </span><span class="s1">case</span> 2:</p>  <p class="p1"><span> </span><span> </span><span> </span><span class="s1">return</span> <span class="s4">&ldquo;&rdquo;</span>+t.<span class="s3">id_str</span>;</p>  <p class="p1"><span> </span><span> </span><span class="s1">case</span> 3:</p>  <p class="p1"><span> </span><span> </span><span> </span><span class="s1">return</span> <span class="s4">&ldquo;&rdquo;</span>+t.<span class="s3">text</span>;</p>  <p class="p1"><span> </span><span> </span>}</p>  <p class="p3"><span class="s2"><span> </span><span> </span></span>return<span class="s2"> </span>null<span class="s2">;</span></p>  <p class="p1"><span> </span>}</p>    <p class="p4"><span class="s2"><span> </span></span>@Override</p>  <p class="p1"><span> </span><span class="s1">public</span> <span class="s1">boolean</span> isNull(<span class="s1">int</span> arg0) {</p>  <p class="p5"><span class="s2"><span> </span><span> </span></span>// <span class="s5">TODO</span> Auto-generated method stub</p>  <p class="p3"><span class="s2"><span> </span><span> </span></span>return<span class="s2"> </span>false<span class="s2">;</span></p>  <p class="p1"><span> </span>}</p>    <p class="p1"><span> </span><span class="s1">private</span> <span class="s1">void</span> loadData() {</p>    <p class="p1"><span> </span><span> </span>HttpClient client = AndroidHttpClient.newInstance(<span class="s4">&ldquo;TwiAndroid&rdquo;</span>);</p>  <p class="p6"><span class="s2">        HttpGet get = </span><span class="s1">new</span><span class="s2"> HttpGet(</span>&ldquo;http://search.twitter.com/search.json?q=mlb&rdquo;<span class="s2">);</span></p>    <p class="p1">        <span class="s1">try</span> {</p>  <p class="p1"><span> </span><span> </span><span> </span>HttpResponse resp = client.execute(get);</p>  <p class="p2"><span> </span><span> </span><span> </span></p>  <p class="p1"><span> </span><span> </span><span> </span>BufferedReader reader = <span class="s1">new</span> BufferedReader(<span class="s1">new</span> InputStreamReader(resp.getEntity().getContent()));</p>  <p class="p1"><span> </span><span> </span><span> </span>String line = <span class="s1">null</span>;</p>  <p class="p1"><span> </span><span> </span><span> </span>StringBuilder r = <span class="s1">new</span> StringBuilder();</p>  <p class="p1"><span> </span><span> </span><span> </span><span class="s1">while</span>((line = reader.readLine())!=<span class="s1">null</span>) {</p>  <p class="p1"><span> </span><span> </span><span> </span><span> </span>Log.d(<span class="s4">&ldquo;AAAA&rdquo;</span>, line);</p>  <p class="p1"><span> </span><span> </span><span> </span><span> </span>r.append(line);</p>  <p class="p1"><span> </span><span> </span><span> </span>}</p>  <p class="p2"><span> </span><span> </span><span> </span></p>  <p class="p1"><span> </span><span> </span><span> </span>JSONObject obj = <span class="s1">new</span> JSONObject(r.toString());</p>  <p class="p2"><span> </span><span> </span><span> </span></p>  <p class="p1"><span> </span><span> </span><span> </span>JSONArray ary = obj.getJSONArray(<span class="s4">&ldquo;results&rdquo;</span>);</p>  <p class="p2"><span> </span><span> </span><span> </span></p>  <p class="p1"><span> </span><span> </span><span> </span><span class="s1">for</span>(<span class="s1">int</span> i=0;i&lt;ary.length();i++) {</p>  <p class="p1"><span> </span><span> </span><span> </span><span> </span>Tweet t = <span class="s1">new</span> Tweet();</p>  <p class="p1"><span> </span><span> </span><span> </span><span> </span>t.<span class="s3">created_at</span> = ary.getJSONObject(i).getString(<span class="s4">&ldquo;created_at&rdquo;</span>);</p>  <p class="p1"><span> </span><span> </span><span> </span><span> </span>t.<span class="s3">id_str</span> = ary.getJSONObject(i).getString(<span class="s4">&ldquo;id_str&rdquo;</span>);</p>  <p class="p1"><span> </span><span> </span><span> </span><span> </span>t.<span class="s3">text</span> = ary.getJSONObject(i).getString(<span class="s4">&ldquo;text&rdquo;</span>);</p>    <p class="p1"><span> </span><span> </span><span> </span><span> </span><span class="s3">tweets</span>.add(t);</p>  <p class="p1"><span> </span><span> </span><span> </span>}</p>  <p class="p1">        } <span class="s1">catch</span> (ClientProtocolException e) {</p>  <p class="p5"><span class="s2"><span> </span><span> </span><span> </span></span>// <span class="s5">TODO</span> Auto-generated catch block</p>  <p class="p1"><span> </span><span> </span><span> </span>e.printStackTrace();</p>  <p class="p1"><span> </span><span> </span>} <span class="s1">catch</span> (IOException e) {</p>  <p class="p5"><span class="s2"><span> </span><span> </span><span> </span></span>// <span class="s5">TODO</span> Auto-generated catch block</p>  <p class="p1"><span> </span><span> </span><span> </span>e.printStackTrace();</p>  <p class="p1"><span> </span><span> </span>} <span class="s1">catch</span> (JSONException e) {</p>  <p class="p5"><span class="s2"><span> </span><span> </span><span> </span></span>// <span class="s5">TODO</span> Auto-generated catch block</p>  <p class="p1"><span> </span><span> </span><span> </span>e.printStackTrace();</p>  <p class="p1"><span> </span><span> </span>}</p>  <p class="p1"><span> </span>}</p>  <p class="p1">}</p>    </blockquote>  <p>其實就是利用getCount()時去存取Twitter search API</p>  <p>為什麼要在這時候呢? 主要是我在remote端用的是Cursor來bind這些資料, 第一個會被呼叫到的是getCount()</p>  <p>由於整個Cursor會被跑在Provider所在的process並非跟caller同一個process, 所以heap也是吃在provider</p>  <p>這種利用Custom cursor應該可以組合出其他不同的作法跟應用&hellip;</p>  </div>
