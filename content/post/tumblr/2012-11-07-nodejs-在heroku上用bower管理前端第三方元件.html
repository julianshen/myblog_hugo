---
date: "2012-11-07T23:19:07Z"
tags:
- IFTTT
- Blogger
- nodejs
title: '[node.js] 在heroku上用bower管理前端第三方元件'
tumblr_url: http://blog.jln.co/post/35203872114/nodejs-在heroku上用bower管理前端第三方元件
---
<p>在做web applications時，或多或少都會使用到像是jQuery, bootstrap這類的第三方元件，使用已經host在既有CDN 的版本（比如說google的）是一個不錯的方法，但不是每一種都有這類方案，一個個從各網站下載回本地端又不是那麼容易管理，<a href="http://bit.ly/QuXxeM">bower</a>就是為此出現的，<a href="http://bit.ly/QuXxeM">bower</a>是一個類似npm的軟體，由Twitter所開發出來且是開放原始碼，所不同的是，npm是管理node.js相關的套件，但bower是管前端的<br/><br/>舉一個例子，你可以利用bower來安裝jQuery :<br/></p><blockquote><em>bower install jQuery</em></blockquote>bower會把jQuery 安裝到<i>&ldquo;components/jQuery&rdquo;</i> 目錄裡<br/><br/>在npm , 你可以把所有相關的模組設定在package.json中，這樣就不用一個個下&quot;npm install mypackage&quot;這樣的指令了，bower也有類似的設計，只是為了避免跟package.json造成混淆它採用的檔名是component.json，內容跟package.json差不多：<br/><blockquote><em>{</em><br/><em>    dependencies: {</em><br/><em>      &ldquo;JQuery&rdquo;: &ldquo;*&rdquo;</em><br/><em>    }</em><br/><em>}</em></blockquote>在Heroku deploy node.js app有個很方便的地方是，當你做git push 後，它會根據package.json自動幫你安裝相關的node.js 模組，但不幸的是它並不支援bower，只支援npm<br/><br/>還好Heroku很有彈性，可以藉由buildpack來自己加這部份<br/><br/><a href="http://bit.ly/SqrY1M">buildpack API</a>其實還蠻簡單的, 基本上只要準備三支shell script:<br/><ul><li>bin/detect</li><li>bin/compile</li><li>bin/release</li></ul><div>大部分的東西, 大多在&quot;bin/compile&quot;裡完成的</div><div><br/></div><div>自己做的buildpack也只要放github, 然後將自己app的buildpack指定到這來即可 (使用heroku toolbelt):</div><div><ul><li>新建的程式使用自己的buildpack:  <br/><i style="background-color: #cccccc;">heroku create myapp &ndash;buildpack <a href="http://bit.ly/SqrV6k">http://bit.ly/SqrV6k</a> </i></li><li>既有的程式更換buildpack:<br/><span style="background-color: #cccccc;"><i>heroku config:add BUILDPACK_URL=http://bit.ly/SqrV6k</i></span></li></ul></div>當然, 不需要重頭建立自己的buildpack, Heroku官方的buildpack都有open source在github上, 如<a href="http://bit.ly/RVJcUf">Node.js buildpack</a>, 所以只要fork出來修改即可, 因此我從<a href="http://bit.ly/RVJcUf">Node.js buildpack</a> fork出一個新的<a href="http://bit.ly/RVJf2u">buidlpack</a>, 主要的修改是:<br/><br/><ol><li>安裝bower</li><li>找出所有的component.json並用&quot;bower install&quot;安裝套件</li></ol><div>本想說 &ldquo;1&rdquo; 應該蠻簡單的, 因為bower也是用node.js開發的, 應該只要用npm install bower就搞定了, 但事實是, 這樣會碰壁, 因為bower採用了<a href="http://bit.ly/Js8SYF">lodash</a> , lodash跟Heroku的npm似乎八字不合, 安裝過程到lodash的post-install就會失敗, 也沒明顯的錯誤, 只說這應該是套件問題, 而去查了lodash, 也有人報過類似的issue, 但作者卻以lodash沒問題應該是npm的問題把這issue給關了(鬼打牆?), 但:</div><div><ul><li>自己電腦上安裝bower或lodash都沒問題</li><li>在自己的package.json加上lodash, deploy到Heroku也一樣掛</li><li>在package.json裡設定engine裡的npm版本到最新的1.1.65(跟自己電腦上一樣版本), 也一樣不行</li></ul></div><br/>那&hellip;就不得不懷疑是npm問題了, 查了原本buildpack寫的, Heroku的node.js和npm其實是拿他們自己放在S3的binary package來安裝的, 可疑!<br/><br/>因此就使用了下一招 - 用npm來裝npm<br/><br/>用Heroku系統內的npm來裝npm是可行的, npm install npm的結果是, 會有一份最新的npm被安裝到node_modules底下, 可以用&quot;node_modules/.bin/npm&quot;來呼叫這版本, 因此就加上了:<br/><blockquote class="tr_bq"><i>node_modules/.bin/npm install bower</i></blockquote>Bingo! 這樣可行, bower一樣被安裝到 node_modules/.bin底下, 加上 &ldquo;2&quot;的邏輯到&quot;bin/compile&quot;後就大功告成了,<br/><br/>有修改的部份只有<a href="http://bit.ly/RVJf2w">&quot;bin/compile&rdquo;</a>, 比對一下commit history就可以知道我修改過啥, 中間有做了很多實驗, 所以有不少垃圾commits, 可以忽略<br/><br/>如果有需要這版本buildpack, 也歡迎利用:<br/><h3><a href="http://bit.ly/RVJf2u">http://bit.ly/RVJf2u</a></h3><br/><br/><br/><div id="blogsy_footer" style="clear: both; font-size: small; text-align: right;"><a href="http://bit.ly/jKo32O" target="_blank"><img alt="在Blogsy發表的" height="20" src="http://bit.ly/Nh8z1A" style="margin-right: 5px; vertical-align: middle;" width="20"/>在Blogsy發表的</a></div><br/><br/>
via Blogger <a href="http://bit.ly/WAoUr6">http://bit.ly/WAoUr6</a>
