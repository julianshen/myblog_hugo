---
date: "2011-10-22T03:12:19Z"
tags:
- Android
- Mobile Dev
title: '[Android] javascript injection in WebView'
tumblr_url: http://blog.jln.co/post/11740142031/android-javascript-injection-in-webview
---
<div class="posterous_autopost"><p>上次寫了一篇&quot;<a href="http://julianshen.posterous.com/startactivityforresult-and-callback-in-webvie">startActivityForResult and callback in WebView</a>&ldquo;, 本篇則是上次這篇的延伸應用, 這是有人問我如何inject一整個javascript file到一個web page內(剛剛回顧了一下自己這篇, 發現我把它叫做javascript injection)</p>  <p>其實原理是一樣的, 在載入完原本的web page之後, 一樣透過URL來插入script:</p>  <blockquote>  <p>mWebView.loadUrl(&quot;javascript:var js = <em><strong>document.createElement(&lsquo;script&rsquo;)</strong></em>;js.type = 'text/javascript&rsquo;;js.src = <span style="font-size: small;"><strong>&rsquo;<span style="text-decoration: underline;">http://my_host/1.js</span>&rsquo;</strong></span>;document.getElementsByTagName('head&rsquo;)[0].<span style="text-decoration: underline;"><strong><em><span style="font-size: small;">appendChild(js)</span></em></strong></span>;&rdquo;);</p>  </blockquote>  <p>一樣是透過<strong>&ldquo;javascript:&rdquo;</strong>來inject, 不一樣的只是, 這次我要插入的是一整個js檔, 所以這串javascript的目的就是要建立一個新的script element, 並將它插入head裡, 這樣任務就達成了</p>  <p>但這方法的缺點是, 來源必須是一個url, 也就是要把script file放在server才可以, 如果script是來自應用程式本身, 比如說放在應用程式apk裡面, 或是放在data partition就不行了</p>  <p>在Honeycomb之前的版本, 我還沒想到一個比較好的解法, 但Honeycomb (API level 11, 含11)之後就有一個比較簡單的解法了</p>  <p>作法就是overwrite <a href="http://developer.android.com/reference/android/webkit/WebViewClient.html#shouldInterceptRequest(android.webkit.WebView,%20java.lang.String)">WebViewClient的shouldInterceptRequest</a>,這似乎就是為了類似的用途而生的呀~~</p>  <p>  <script src="https://gist.github.com/1304648.js?file=gistfile1.java"></script></p>  <p>這邊我將來自於apk asset目錄裡的檔案的url定義成&quot;asset://&ldquo;, 因此, 想當然耳, 要導向的url就是這種, 作法也很簡單, 將asset的input stream包裝成<a href="http://developer.android.com/reference/android/webkit/WebResourceResponse.html">WebResourceResponse</a>就可以了, 這樣只要&quot;js.src=&quot;後面的url是&quot;asset://xxx.js&rdquo;, 這js的來源就是apk裡的asset</p>  <p>缺點是, 這方法只適用API level 11之後</p>  <p>延伸應用? 其實應該可以利用這個API做出一個lightweight版本的client side serlvet (這樣叫好像也不是很貼切, 反正就是不需要透過http去存取), 不過因為資訊只有url可以使用, 因此不能implement &ldquo;POST&rdquo;&hellip;</p>    <p>題外話, 這個我是在Ice cream sandwich的emulator上測試的, 不過真的要小抱怨一下, 開個emulator要開很久, 看篇漫畫結束後還沒跑完, 如果叫developer完全用emulator開發, 真的會抓狂吧&hellip;.這樣開發者的開發意願也會降低吧&hellip;. = =&ldquo;</p></div>
