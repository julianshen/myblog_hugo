---
date: "2011-07-16T22:43:14Z"
tags:
- Android
- Mobile Dev
title: startActivityForResult and callback in WebView
tumblr_url: http://blog.jln.co/post/7688436064/startactivityforresult-and-callback-in-webview
---
<div class="posterous_autopost"><p>想半天標題不知道怎下, 有點不是很貼切, 內容也寫的有點懶 :P 有可能會看不懂吧</p>  <p>最近開始想要一個禮拜想一個東西來實踐一下(不知道可以持續多久:P), 這禮拜想到的是這個: 從WebView內的javascript去叫起一個Activity, 然後把這Activity回傳的結果回傳給WebView內的javascript</p>  <p>具體的假想應用範例: import contact information, 從Javascript內叫contact picker, 並把所選的contact資訊匯入WebView內的form中</p>  <p>首先, 呼叫contact picker的範例如下:</p>  <blockquote class="posterous_medium_quote">  <p>public void launch()</p>  <p>{ <br/>    Intent intent = new Intent(Intent.<strong>ACTION_PICK</strong>); <br/>    intent.setType(<strong>ContactsContract.Contacts.CONTENT_TYPE</strong>); <br/>    startActivityForResult(intent, PICK_CONTACT); <br/> }</p>  </blockquote>  <p>基本上, 是要使用startActivityForResult, 這樣才能把所選定的contact給回傳給我們的Activity</p>  <p>但如何讓這lauch被javascript call到呢? 我們必須把這個method封裝到一個class內, 我用一個名叫ContactLauncher的class來做封裝, 並且將這個interface指定給WebView：</p>  <blockquote class="posterous_short_quote">  <p>webView.addJavascriptInterface(new ContactLauncher(), &ldquo;contactPicker&rdquo;);</p>  </blockquote>  <p>這樣一來, 我們在javascript內就有一個contactPicker可以供呼叫了, javascript的範例如下:</p>  <blockquote>  <p>function launchPicker() <br/>{ <br/>    if(contactPicker) { <br/>         <span style="color: #00ff00;"><em>//register callback </em></span><br/><span style="color: #00ff00;"><em>          window.activitycallback = function(response) { </em></span><br/><span style="color: #00ff00;"><em>                  $(&rsquo;#name&rsquo;).val(response.name); </em></span><br/><span style="color: #00ff00;"><em>          }; </em></span></p>          <span style="color: #ffff00;"><strong>//call picker </strong></span><br/><span style="color: #ffff00;"><strong>         contactPicker.launch(); </strong></span><br/>    } else { 			//no picker 		} <br/> }  </blockquote>  <p>我們可以在javascript內透過&quot;contactPicker.launch()&ldquo;來叫起Contact picker, 這個就會直接呼叫ContactLauncher裡的lauch()</p>  <p>那在這之前的程式碼是幹啥用的呢? 由於launch()並不是一個blocking call, 並不會等到結果回傳後才結束, 而我們又要startActivityForResult回傳回來的資料, 因此我們需要一個callback來接收回傳的資料</p>  <p>那怎讓javascript可以接收回傳回來後的資料呢, 這邊我利用一個類似javascript injection的方式來做(原理是利用WebView可以接收&quot;javascript:&quot;這種形態的url)</p>  <p>以下是onActivityResult的實作 (這邊偷懶只取一個Display name):</p>  <blockquote>    <div class="CodeRay"> <div class="code"><pre>protected void onActivityResult(int requestCode, int resultCode, Intent data) { if(requestCode == PICK_CONTACT) { Cursor c = managedQuery(data.getData(), null, null, null, null); c.moveToNext(); String name = c.getString(c.getColumnIndexOrThrow(ContactsContract.Contacts.DISPLAY_NAME));  String json = "{name:'"+name+"'}"; webView.loadUrl("javascript:window.activitycallback("+json+");"); } }</pre></div> </div>   <p> </p>  </blockquote>  <p>因為在WebView內的那個javascript page我已經先安插了一個activitycallback, 所以就利用loadUrl來呼叫它, 這樣就大功告成了!</p>  <p>這只是一個簡單的範例, 還可以做的更generic一點, 比如說把傳入的資料轉化成json這段, 這招應該還可以做一些應用才對</p>  </div>
