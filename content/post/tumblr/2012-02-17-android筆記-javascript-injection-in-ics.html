---
date: "2012-02-17T22:52:56Z"
tags:
- Android
- Mobile Dev
title: '[Android][筆記] JavaScript injection in ICS'
tumblr_url: http://blog.jln.co/post/17766305018/android筆記-javascript-injection-in-ics
---
<div class="posterous_autopost"><p>看來script injection也不算是啥旁門左道了, 在Android 4.0 ICS上的WebView也使用了同樣的技巧了(在Gingerbread上並未看到這樣的codes)</p>  <div class="p_embed p_image_embed"> <img alt="Device-2012-02-17-171716" height="800" src="http://getfile2.posterous.com/getfile/files.posterous.com/temp-2012-02-17/ClvgGrzwzwtFulquchnqsrfFHpByJrlyyxvFtuIcvjGzHgtsBkqwsyztBJJk/device-2012-02-17-171716.png.scaled500.png" width="480"/></div>   <p>在ICS的Setting裡面&quot;Accessiblity&quot;裡有個設定叫&quot;Install web script&quot;, 其實這東西應該沒使用者看的懂, 其實蠻怪的, 不過既然放了就有它的作用</p>  <p>ICS的WebView裡面有這樣一段codes:</p>  <blockquote>  <p>int axsParameterValue = getAxsUrlParameterValue(url);</p>  <p>        if (axsParameterValue == ACCESSIBILITY_SCRIPT_INJECTION_UNDEFINED) {</p>  <p>            boolean onDeviceScriptInjectionEnabled = (Settings.Secure.getInt(mContext</p>  <p>                    .getContentResolver(), Settings.Secure.ACCESSIBILITY_SCRIPT_INJECTION, 0) == 1);</p>  <p>            if (onDeviceScriptInjectionEnabled) {</p>  <p>                ensureAccessibilityScriptInjectorInstance(false);</p>  <p>                // neither script injected nor script injection opted out =&gt; we inject</p>  <p>                loadUrl(ACCESSIBILITY_SCRIPT_CHOOSER_JAVASCRIPT);</p>  <p>                // TODO: Set this flag after successfull script injection. Maybe upon injection</p>  <p>                // the chooser should update the meta tag and we check it to declare success</p>  <p>                mAccessibilityScriptInjected = true;</p>  <p>            } else {</p>  <p>                // injection disabled so we fallback to the basic built-in support</p>  <p>                ensureAccessibilityScriptInjectorInstance(true);</p>  <p>            }</p>  <p>        } else if (axsParameterValue == ACCESSIBILITY_SCRIPT_INJECTION_OPTED_OUT) {</p>  <p>            // injection opted out so we fallback to the basic buil-in support</p>  <p>            ensureAccessibilityScriptInjectorInstance(true);</p>  <p>        } else if (axsParameterValue == ACCESSIBILITY_SCRIPT_INJECTION_PROVIDED) {</p>  <p>            ensureAccessibilityScriptInjectorInstance(false);</p>  <p>            // the URL provides accessibility but we still need to add our generic script</p>  <p>            loadUrl(ACCESSIBILITY_SCRIPT_CHOOSER_JAVASCRIPT);</p>  <p>        } else {</p>  <p>            Log.e(LOGTAG, &ldquo;Unknown URL value for the "axs" URL parameter: &rdquo; + axsParameterValue);</p>  <p>        }</p>      </blockquote>  <p>  </p><div>這功能啟動的條件是url裡有&quot;axs=1&quot;或是剛講的那個設定是enabled, 而這一整段code是在onPageFinished最後被呼叫到的, 也就是頁面載入完成之後</div>    <div>它主要做的只有:</div>    <blockquote class="posterous_short_quote">  <p> loadUrl(<strong>ACCESSIBILITY_SCRIPT_CHOOSER_JAVASCRIPT</strong>);</p>  </blockquote>  <p>這邊並不是強制去載入一個新的URL, 其實他做的就是script injection, <strong>ACCESSIBILITY_SCRIPT_CHOOSER_JAVASCRIPT</strong>的內容就是:</p>  <blockquote>  <p>    // JavaScript to inject the script chooser which will</p>  <p>    // pick the right script for the current URL</p>  <p>    private static final String ACCESSIBILITY_SCRIPT_CHOOSER_JAVASCRIPT =</p>  <p>        &ldquo;javascript:(function() {&rdquo; +</p>  <p>        &ldquo;    var chooser = document.createElement(&lsquo;script&rsquo;);&rdquo; +</p>  <p>        &ldquo;    chooser.type = 'text/javascript&rsquo;;&rdquo; +</p>  <p>        &ldquo;    chooser.src = 'https://ssl.gstatic.com/accessibility/javascript/android/AndroidScriptChooser.user.js&rsquo;;&rdquo; +</p>  <p>        &ldquo;    document.getElementsByTagName('head&rsquo;)[0].appendChild(chooser);&rdquo; +</p>  <p>        &ldquo;  })();&rdquo;;</p>    </blockquote>  <p>它就是在最後把<a href="https://ssl.gstatic.com/accessibility/javascript/android/AndroidScriptChooser.user.js">https://ssl.gstatic.com/accessibility/javascript/android/AndroidScriptChooser.user.js</a>給inject到page</p>  <p>還沒去仔細看js裡面的內容, 似乎都是一些基本的東西的樣子, 還不太知道他的用意, 不過應該跟加速(?) Google本身的頁面有關係, 不然其他web site應該也沒用到這些東西</p>  </div>
