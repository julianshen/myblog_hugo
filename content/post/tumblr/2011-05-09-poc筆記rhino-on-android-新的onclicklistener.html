---
date: "2011-05-09T00:34:09Z"
tags:
- Android
- javascript
- Mobile Dev
- Rhino
title: '[POC][筆記][Rhino on Android] - 新的onClickListener'
tumblr_url: http://blog.jln.co/post/5307727600/poc筆記rhino-on-android-新的onclicklistener
---
<div class="posterous_autopost"><p><a href="http://julianshen.posterous.com/pocrhino-developing-android-with-js-onclickli">上次的作法</a>:</p>  <blockquote>  <p><span style="color: #800000;">var</span> button1 = findview(R.id(<span style="color: #3366ff;">&lsquo;button1&rsquo;</span>));</p>  <p>button1.setOnClickListener(<span style="color: #800000;">function</span>(view, methodName)<br/>{<br/>     if (methodName == <span style="color: #3366ff;">&ldquo;onClick&rdquo;</span>) { <br/>         log(&ldquo;MyScript&rdquo;, &ldquo;clicked&rdquo;); <br/> } });</p>    </blockquote>  <p>當然不是很滿意, &ldquo;if(methodName == &quot;onClick&rdquo;)&ldquo;這樣的寫法太醜了啦!</p>  <p>所以這次的目標是:</p>  <blockquote class="posterous_short_quote">  <p>button1.onclick = function(view) {</p>  <p>     log(&quot;MyScript&rdquo;, &ldquo;clicked&rdquo;);</p>  <p>     alert('Hi there!&rsquo;);</p>  <p>};</p>  </blockquote>  <p>這樣比較像印象中javascript的寫法</p>  <p>為了達到這目的, 必須在View中加入onclick這個property, 但原本View class(Java)並沒這東西, 如何將它包裝出來?</p>  <p>Rhino對於Javascript使用原生的java objects並不是直接使用, 還是有透過一層包裝, 因此這就是要做出這個property的路了, 包裝的點在於<a href="http://www.mozilla.org/rhino/apidocs/org/mozilla/javascript/WrapFactory.html">WrapFactory</a>, 而原生的Java object會被包裝長NativeJavaObject </p>  <p>而Rhino允許我們用自己的WrapFactory取代原本的, 像是這樣:</p>  <blockquote>  <p>jsContext.setWrapFactory(new <strong><span style="color: #ff6600;">AndroidWrapFactory()</span></strong>);</p>  </blockquote>  <p>因此我們會需要自己實作這一個AndroidWrapFactory, 把原本的View改用不同的包裝, 而非原本的NativeJavaObject, 基本上只需要實作wrapAsJavaObject即可:</p>  <p>  <script src="https://gist.github.com/961470.js?file=AndroidWrapFactory.java"></script></p>    <p>這邊用了一個新實作的ViewWrapper來取代NativeJavaObject</p>  <p>  <script src="https://gist.github.com/961471.js?file=ViewWrapper.java"></script></p>  <p>本來我的打算是繼承自NativeJavaObject, 然後再加入自己的東西, 不過後來發現這樣的作法總會在&quot;put&quot;時出差錯, 原因是NativeJavaObject是沒辦法加入新的member了(其實這說法有點問題, 應該是只要設prototype給它的話還是可以), 加上一些比較實用的function是定義在ScriptableObject的裡面, 因此, 我最後採用ScriptableObject來包裝</p>  <p>但要如何在ScriptableObject裡面實現像NativeJavaObject那樣可以直接叫用原本的Java class裡面的member呢?這部份不用自己實作, 只要把原本的NativeJavaObject當做這新的ViewWrapper的prototype就好了, 所以這邊constructor呼叫的super contructor是:</p>  <blockquote class="posterous_short_quote">  <p>public ScriptableObject(Scriptable scope, Scriptable prototype)</p>  <p>===&gt; super(scope, new NativeJavaObject(scope, javaObject, staticType));</p>  </blockquote>  <p>defineProperty這包裝是從ScritableObject那邊改寫其中一個過來的, 主要是用來讓我們可以把這些&quot;onlick&quot;,&ldquo;onlongclick&quot;包裝成property, 在ViewWrapper可以實作getter和setter, 為了避免名稱上的混淆, 所以把getter的prefix定義成&quot;jsget&quot;而setter是&quot;jsset&rdquo;</p>  <p>在onlick的setter中, 除了將function object存起來外, 還直接對原本包裝的View設一個OnClickListener, 動作則是執行這個Function object</p>  <p>最後, 前面的範例裡面有一個&quot;alert('Hi! there&rsquo;)&ldquo;, 因此為了&quot;alert()&quot;多實作一個Alert.java出來(跟上面的無關啦), 這是source:</p>  <p>  <script src="https://gist.github.com/961481.js?file=Alert.java"></script></p>    <p>接下來的目標, </p>  <ul><li>包裝一個實際真的可以拿來開發的package, release 0.1 alpha</li>  <li>實作XmlHttpRequest</li>  <li>Adapter &amp; AdapterView, Service &amp; Provider</li>  </ul></div>
